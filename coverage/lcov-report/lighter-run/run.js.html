<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lighter-run/run.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">lighter-run/</a> run.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">47.67% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>41/86</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">39.29% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>11/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">20% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">48.24% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>41/85</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">#!/usr/bin/env node
&nbsp;
var spawn = require('child_process').spawn
var config = require('lighter-config').run || {}
var stdout = process.stdout
var node = process.execPath
var args = process.argv.slice(3)
var cwd = process.cwd()
var env = process.env
&nbsp;
// Find the "main" file in "package.json".
try {
  var main = require.resolve(cwd)
  args.unshift(main)
} catch (e) {
<span class="cstat-no" title="statement not covered" >  console.log(e)</span>
<span class="cstat-no" title="statement not covered" >  console.log('The current directory does not contain a node application.')</span>
<span class="cstat-no" title="statement not covered" >  console.log('Please run "npm init" and create an entry point file.')</span>
<span class="cstat-no" title="statement not covered" >  process.exit()</span>
}
&nbsp;
// Try to restart in half a second.
var minRestartTime = config.minRestartTime || 500
&nbsp;
// Wait 5 seconds at most.
var maxRestartTime = config.maxRestartTime || 5e4
&nbsp;
// Wait twice as long each time.
var restartTimeBackoff = config.restartTimeBackoff || 2
&nbsp;
// Call a restart "ok" after 2 seconds without failing.
var cleanTime = config.cleanTime || 2e3
&nbsp;
// The first time we restart, do it quickly.
var restartTime = 0
&nbsp;
// Keep a reference to the child process.
var child
&nbsp;
// Watch for changes.
var fsevents = require('fsevents')
var watcher = fsevents(cwd)
watcher.on('change', changed)
watcher.start()
&nbsp;
// Remember when we last started.
var previousStart = new Date(0)
var failureOutput
var startTimer
&nbsp;
// Start the application!
start()
&nbsp;
/**
 * Respond to a change event.
 * @param  {String} path  Path of the file in which the change occurred.
 * @param  {Object} info  Information about the change from `fsevents`.
 */
<span class="fstat-no" title="function not covered" >function changed (path, info) {</span>
<span class="cstat-no" title="statement not covered" >  var time = (new Date()).toTimeString()</span>
<span class="cstat-no" title="statement not covered" >  if (path.indexOf(cwd + '/') === 0) {</span>
<span class="cstat-no" title="statement not covered" >    path = path.slice(cwd.length + 1)</span>
  }
<span class="cstat-no" title="statement not covered" >  var what = info.event.replace(/^\w/, <span class="fstat-no" title="function not covered" >function (c) {</span> <span class="cstat-no" title="statement not covered" >return c.toUpperCase() }</span>)</span>
<span class="cstat-no" title="statement not covered" >  var when = '\u001b[90m at ' + time + '\u001b[39m'</span>
<span class="cstat-no" title="statement not covered" >  console.log('\n\u001b[33m' + what + ' "' + path + '"' + when)</span>
<span class="cstat-no" title="statement not covered" >  if (child) {</span>
<span class="cstat-no" title="statement not covered" >    if (/is-hot-reloadable/.test(path)) {</span>
<span class="cstat-no" title="statement not covered" >      child.stdin.write(info)</span>
    } else {
<span class="cstat-no" title="statement not covered" >      child.kill()</span>
<span class="cstat-no" title="statement not covered" >      child = undefined</span>
    }
  }
}
&nbsp;
/**
 * Get a string of numberless ordered lines for deduping logs.
 * @param  {String} text  Text received from the child's stdout.
 * @return {String}       Numberless ordered lines.
 */
<span class="fstat-no" title="function not covered" >function munge (text) {</span>
<span class="cstat-no" title="statement not covered" >  var lines = ('' + text).split('\n')</span>
<span class="cstat-no" title="statement not covered" >  lines.forEach(<span class="fstat-no" title="function not covered" >function (line, index) {</span></span>
<span class="cstat-no" title="statement not covered" >    lines[index] = lines[index].replace(/\d+/, '')</span>
  })
<span class="cstat-no" title="statement not covered" >  lines.sort()</span>
<span class="cstat-no" title="statement not covered" >  text = lines.join('\n')</span>
<span class="cstat-no" title="statement not covered" >  return text</span>
}
&nbsp;
/**
 * Start an application.
 */
function start () {
  var output
  var now = new Date()
  var elapsed = now - previousStart
&nbsp;
  // If it's been a while since we restarted, call this a clean start.
  var isCleanStart = elapsed &gt; cleanTime
  previousStart = now
&nbsp;
  child = spawn(node, args, {cwd: cwd, env: env})
&nbsp;
  // When we've started cleanly, pipe child process output directly to stdout.
  <span class="missing-if-branch" title="else path not taken" >E</span>if (isCleanStart) {
    pipe()
    restartTime = 0
&nbsp;
  // After a fast failure, buffer the output in case we fail again.
  } else {
<span class="cstat-no" title="statement not covered" >    output = ''</span>
<span class="cstat-no" title="statement not covered" >    var append = <span class="fstat-no" title="function not covered" >function (chunk) {</span></span>
<span class="cstat-no" title="statement not covered" >      output += chunk</span>
    }
<span class="cstat-no" title="statement not covered" >    child.stdout.on('data', append)</span>
<span class="cstat-no" title="statement not covered" >    child.stderr.on('data', append)</span>
&nbsp;
    // When we've started cleanly, write output to stdout and start piping.
<span class="cstat-no" title="statement not covered" >    startTimer = setTimeout(<span class="fstat-no" title="function not covered" >function () {</span></span>
<span class="cstat-no" title="statement not covered" >      write(output + '\n')</span>
<span class="cstat-no" title="statement not covered" >      child.stdout.removeListener('output', append)</span>
<span class="cstat-no" title="statement not covered" >      child.stderr.removeListener('output', append)</span>
<span class="cstat-no" title="statement not covered" >      pipe()</span>
<span class="cstat-no" title="statement not covered" >      output = ''</span>
<span class="cstat-no" title="statement not covered" >      restartTime = 0</span>
    }, cleanTime)
  }
&nbsp;
  // When a child process dies, restart it.
  child.on('close', <span class="fstat-no" title="function not covered" >function () {</span>
    // If we failed differently, log the new output.
<span class="cstat-no" title="statement not covered" >    if (failureOutput &amp;&amp; (munge(output) !== munge(failureOutput))) {</span>
<span class="cstat-no" title="statement not covered" >      write(output)</span>
&nbsp;
    // If we failed the same way, just show another red dot.
    } else <span class="cstat-no" title="statement not covered" >if (child) {</span>
<span class="cstat-no" title="statement not covered" >      write('\u001b[31m.\u001b[39m')</span>
    }
<span class="cstat-no" title="statement not covered" >    failureOutput = output</span>
<span class="cstat-no" title="statement not covered" >    clearTimeout(startTimer)</span>
<span class="cstat-no" title="statement not covered" >    startTimer = setTimeout(start, restartTime)</span>
<span class="cstat-no" title="statement not covered" >    restartTime = Math.min(restartTime * restartTimeBackoff, maxRestartTime) || minRestartTime</span>
  })
}
&nbsp;
/**
 * Start piping output data to stdout.
 */
function pipe () {
  child.stdout.pipe(stdout)
  child.stderr.pipe(stdout)
}
&nbsp;
/**
 * Try writing to `stdout`, and ignore failures.
 * @param  {Buffer} data  Data to write to stdout.
 */
<span class="fstat-no" title="function not covered" >function write (data) {</span>
<span class="cstat-no" title="statement not covered" >  if (data) {</span>
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      stdout.write(data)</span>
    } catch (e) {
      // TODO: Debug "TypeError: invalid data" at WriteStream.Socket.write
    }
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Oct 10 2016 05:42:54 GMT-0700 (PDT)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
